# Deepkit Nx Demo

Demo setup for Deepkit Framework with Nx monorepo.

> Deepkit<br>
> High Performance Typescript Framework
> 
> High-quality TypeScript libraries and next-gen backend framework.
Leverage TypeScript types to the fullest, in completely new ways.

See https://deepkit.io/


## Install

use Node v16

```shell
npm i
```

## Start App

Run the app as command (cli):

```shell
nx start app-backend
```

Pass parameter to the command:

```shell
nx start app-backend app:config
```

Run the app and start the server:

```shell
nx serve app-backend
```

## Configure Nx

To use Deepkit with Nx a few things needs to be configured.

You may also have a look into the Deepkit documentation
https://docs.deepkit.io/english/runtime-types.html#runtime-types-installation

### [package.json](package.json)

The Deepkit type compiler needs to be installed. This can be automated.

```json
{
  ...
  "scripts": {
    "postinstall": "node_modules/.bin/deepkit-type-install"
  },
  ...
}
```

### [tsconfig.base.json](tsconfig.base.json)

The reflection has to be enabled.
Other packages include the base config, therefor this needs to be done in tsconfig.base.json only.

```json
{
  "reflection": true,
  "compilerOptions": {
    ...
  },
  "exclude": ["node_modules", "tmp", "var"],
  "ts-node": {
    "require": ["tsconfig-paths/register"]
  }
}
```

### [webpack-deepkit.config.js](webpack-deepkit.config.js)

Is needed for Webpack builds, like `nx serve ...`

A `webpackConfig` entry in projects.json has to be added where `"executor": "@nrwl/webpack:webpack"` is used. See below in **projects.json**.

Nx creates the webpack config on the fly. The `webpack-deepkit.config.js` alters the config instead of replacing it.

### [project.json](packages%2Fapp-backend%2Fproject.json)

A app package is added to the repository with 

```shell
nx g @nrwl/node:application app-backend
```

The generated project.json needs to be changed.

Added:

- targets.build.options.webpackConfig
- targets.start
- targets.serve.options.args

```json
{
  "name": "app-backend",
  "$schema": "../../node_modules/nx/schemas/project-schema.json",
  "sourceRoot": "packages/app-backend/src",
  "projectType": "application",
  "targets": {
    "build": {
      "executor": "@nrwl/webpack:webpack",
      "outputs": ["{options.outputPath}"],
      "options": {
        "target": "node",
        "compiler": "tsc",
        "outputPath": "dist/packages/app-backend",
        "main": "packages/app-backend/src/main.ts",
        "tsConfig": "packages/app-backend/tsconfig.app.json",
        "webpackConfig": "./webpack-deepkit.config.js",
        "assets": ["packages/app-backend/src/assets"]
      },
      "configurations": {
        ...
      }
    },
    "start": {
      "executor": "nx:run-commands",
      "options": {
        "command": "NODE_ENV=development ts-node -r tsconfig-paths/register -P packages/app-backend/tsconfig.app.json packages/app-backend/src/main.ts"
      }
    },
    "serve": {
      "executor": "@nrwl/js:node",
      "options": {
        "buildTarget": "app-backend:build",
        "args": ["server:start"]
      },
      "configurations": {
        "production": {
          "buildTarget": "app-backend:build:production"
        }
      }
    },
    ...
  },
}
```

With that config...

**nx start** uses ts-node

**nx serve** uses webpack build

### .gitignore

```gitignore
/var
```

### [.eslintrc.json](.eslintrc.json)

Following eslint rules makes the missing type an error:

```json
      "rules": {
        "@typescript-eslint/no-inferrable-types": "off",
        "@typescript-eslint/typedef": [
          "error",
          {
            "memberVariableDeclaration": true
          }
        ]
      }
```


# Notes

<a href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a>

✨ **This workspace has been generated by [Nx, a Smart, fast and extensible build system.](https://nx.dev)** ✨

```shell
npx create-nx-workspace@latest deepkit-nx-demo --preset=ts
cd deepkit-nx-demo
npm install -D @nrwl/node
nx g @nrwl/node:application app-backend
```

Add a lib:

```shell
npx nx g @nrwl/node:lib lib-book --buildable
```

## Understand this workspace

Run `nx graph` to see a diagram of the dependencies of the projects.

## Further help

Visit the [Nx Documentation](https://nx.dev) to learn more.
